<script>
    function initPage(container = document) {
        [].forEach.call(document.querySelectorAll('[lightbox]'), function(el) {
            el.lightbox = new Lightbox(el);
        });

        document.querySelectorAll('.grid-item-mosaic.videos, .grid-item-mosaic.link').forEach(item => {
            const id = item.getAttribute('data-id');
            const video = item.querySelector('.overlay video');
            const overlay = item.querySelector('.overlay');

            if (!video || !overlay) {
                console.warn('video or overlay missing for item', item);
                return;
            }

            video.muted = true;
            video.playsInline = true;

            let loaded = false;
            const markLoaded = (evt) => {
                loaded = true;
                video.classList.add('is-ready');
            };

            video.addEventListener('loadeddata', markLoaded, { once: true });
            video.addEventListener('canplay', markLoaded, { once: true });
            video.addEventListener('canplaythrough', markLoaded, { once: true });

            const showAndPlay = () => {
                video.classList.add('is-visible');
                video.play().catch(err => {
                    console.warn('video.play() failed for', id, err);
                });
            };

            overlay.addEventListener('mouseenter', () => {
                if (!video.src) {
                    video.src = `/assets/videos/${id}.mp4`;
                    video.load();
                }

                if (video.readyState >= 3 || loaded) {
                    showAndPlay();
                    return;
                }

                const onFirstPlayable = () => {
                    showAndPlay();
                    video.removeEventListener('loadeddata', onFirstPlayable);
                    video.removeEventListener('canplay', onFirstPlayable);
                    video.removeEventListener('canplaythrough', onFirstPlayable);
                };
                video.addEventListener('loadeddata', onFirstPlayable, { once: true });
                video.addEventListener('canplay', onFirstPlayable, { once: true });
                video.addEventListener('canplaythrough', onFirstPlayable, { once: true });
            });

            overlay.addEventListener('mouseleave', () => {
                video.pause();
                video.currentTime = 0;
                video.classList.remove('is-visible');
            });
        });

        document.querySelectorAll('[data-gallery]').forEach((el, i, arr) => {
            const group = el.getAttribute('data-gallery');
            const others = document.querySelectorAll('[data-gallery="' + group + '"]');

            others.forEach((item, idx) => {
                if (idx > 0) {
                    item.closest('.grid-item-mosaic').style.display = 'none';
                }
            });
        });

        const backLink = document.querySelector("#back-link");
        if (backLink) {
            backLink.addEventListener("click", (e) => {
                e.preventDefault();
                history.back();
            });
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const content = document.querySelector("#content");

        async function loadPage(url, push = true) {
            content.classList.add("fade-out");

            const response = await fetch(url);
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, "text/html");
            const newContent = doc.querySelector("#content");

            setTimeout(() => {
                content.innerHTML = newContent.innerHTML;

                const toggle = document.querySelector("#toggle");
                if (toggle) toggle.checked = false;

                content.classList.remove("fade-out");
                content.classList.add("fade-in");

                initPage(content);

                if (push) history.pushState({ url }, "", url);

                window.scrollTo({ top: 0, left: 0, behavior: "smooth" });

                setTimeout(() => content.classList.remove("fade-in"), 300);
            }, 300);
        }

        document.body.addEventListener("click", (e) => {
            const link = e.target.closest("a");
            if (link && link.getAttribute("href")?.startsWith("/") && !link.hasAttribute("target")) {
                e.preventDefault();
                loadPage(link.href, true);
            }
        });

        window.addEventListener("popstate", (e) => {
            if (e.state && e.state.url) {
                loadPage(e.state.url, false);
            } else {
                loadPage(location.href, false);
            }
        });

        window.addEventListener("keydown", (e) => {
            if (e.altKey && e.key === "ArrowLeft") {
                history.back();
            } else if (e.altKey && e.key === "ArrowRight") {
                history.forward();
            }
        });
    });

    console.log(`
░▒▓██████████████▓▒░ ░▒▓██████▓▒░░▒▓███████▓▒░░▒▓████████▓▒░      ░▒▓███████▓▒░░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░░▒▓███████▓▒░
░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░             ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░             ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓████████▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓██████▓▒░        ░▒▓███████▓▒░ ░▒▓██████▓▒░       ░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░
░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░             ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░          ░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░             ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░          ░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓███████▓▒░░▒▓████████▓▒░      ░▒▓███████▓▒░   ░▒▓█▓▒░           ░▒▓██████▓▒░░▒▓███████▓▒░
`);
</script>
